{"version":3,"file":"widget.js","sources":["../src/styles.ts","../src/state.ts","../src/config.ts","../src/components/ConsentGate.ts","../src/utils/compression.ts","../src/utils/exif.ts","../src/utils/validation.ts","../src/components/Camera.ts","../src/components/Upload.ts","../src/components/Progress.ts","../src/services/api.ts","../src/components/Selectors.ts","../src/events.ts","../src/components/Result.ts","../src/components/Modal.ts","../src/api.ts","../src/main.ts"],"sourcesContent":["export const styles = `\n:host {\n  all: initial;\n  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n  font-size: 16px;\n  line-height: 1.5;\n  color: #1a1a1a;\n  box-sizing: border-box;\n}\n\n*, *::before, *::after {\n  box-sizing: border-box;\n}\n\n/* Brand Colors — Muse Hair Pro */\n/* Primary: warm rose-gold / mauve */\n/* Accent: deep plum for contrast */\n\n.backdrop {\n  position: fixed;\n  inset: 0;\n  background: rgba(0, 0, 0, 0.6);\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  z-index: 2147483647;\n  opacity: 0;\n  transition: opacity 0.2s ease;\n}\n\n.backdrop.visible {\n  opacity: 1;\n}\n\n.modal {\n  background: #fff;\n  width: min(480px, 92vw);\n  max-height: 90vh;\n  overflow: auto;\n  border-radius: 16px;\n  padding: 24px;\n  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);\n  transform: scale(0.95);\n  transition: transform 0.2s ease;\n}\n\n.backdrop.visible .modal {\n  transform: scale(1);\n}\n\n.header {\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  margin-bottom: 20px;\n}\n\n.title {\n  margin: 0;\n  font-size: 20px;\n  font-weight: 600;\n  color: #3d2b2b;\n}\n\n.close-btn {\n  width: 32px;\n  height: 32px;\n  border: none;\n  background: #f5f0ee;\n  border-radius: 50%;\n  cursor: pointer;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  font-size: 18px;\n  color: #6b5454;\n  transition: background 0.15s;\n}\n\n.close-btn:hover {\n  background: #e8ddd9;\n}\n\n/* Consent View */\n.consent-content {\n  text-align: center;\n  padding: 20px 0;\n}\n\n.consent-icon {\n  font-size: 48px;\n  margin-bottom: 16px;\n}\n\n.consent-title {\n  font-size: 18px;\n  font-weight: 600;\n  margin: 0 0 12px 0;\n  color: #3d2b2b;\n}\n\n.consent-text {\n  color: #666;\n  margin: 0 0 8px 0;\n  font-size: 14px;\n}\n\n.consent-link {\n  color: #9b6b6b;\n  text-decoration: none;\n}\n\n.consent-link:hover {\n  text-decoration: underline;\n}\n\n.consent-actions {\n  display: flex;\n  gap: 12px;\n  margin-top: 24px;\n  justify-content: center;\n}\n\n/* Capture Tabs */\n.capture-tabs {\n  display: flex;\n  gap: 0;\n  margin-bottom: 16px;\n  border-radius: 10px;\n  background: #f5f0ee;\n  padding: 4px;\n}\n\n.capture-tab {\n  flex: 1;\n  padding: 10px 16px;\n  border: none;\n  background: transparent;\n  border-radius: 8px;\n  font-size: 14px;\n  font-weight: 500;\n  color: #6b5454;\n  cursor: pointer;\n  transition: background 0.15s, color 0.15s;\n}\n\n.capture-tab.active {\n  background: #fff;\n  color: #3d2b2b;\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);\n}\n\n.capture-tab:hover:not(.active) {\n  color: #3d2b2b;\n}\n\n/* Camera View */\n.camera-container {\n  text-align: center;\n}\n\n.camera-viewfinder {\n  position: relative;\n  background: #1a1a1a;\n  border-radius: 12px;\n  overflow: hidden;\n  aspect-ratio: 4/3;\n}\n\n.camera-video {\n  width: 100%;\n  height: 100%;\n  object-fit: cover;\n  transform: scaleX(-1);\n}\n\n.camera-loading {\n  position: absolute;\n  inset: 0;\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  justify-content: center;\n  color: #fff;\n  font-size: 14px;\n}\n\n.camera-loading p {\n  margin: 0;\n}\n\n.camera-actions {\n  margin-top: 16px;\n}\n\n.camera-capture-btn {\n  min-width: 160px;\n}\n\n.camera-error {\n  text-align: center;\n  padding: 32px 16px;\n  background: #faf6f5;\n  border-radius: 12px;\n}\n\n.camera-error-icon {\n  font-size: 40px;\n  margin-bottom: 12px;\n  opacity: 0.5;\n}\n\n.camera-error-title {\n  font-weight: 600;\n  margin: 0 0 8px 0;\n  color: #3d2b2b;\n}\n\n.camera-error-text {\n  color: #666;\n  font-size: 14px;\n  margin: 0;\n}\n\n/* Upload View */\n.upload-zone {\n  border: 2px dashed #d4b8b8;\n  border-radius: 12px;\n  padding: 32px;\n  text-align: center;\n  cursor: pointer;\n  transition: border-color 0.15s, background 0.15s;\n}\n\n.upload-zone:hover,\n.upload-zone.dragover {\n  border-color: #9b6b6b;\n  background: #faf6f5;\n}\n\n.upload-icon {\n  font-size: 40px;\n  margin-bottom: 12px;\n}\n\n.upload-title {\n  font-weight: 600;\n  margin: 0 0 8px 0;\n}\n\n.upload-subtitle {\n  color: #666;\n  font-size: 14px;\n  margin: 0;\n}\n\n.upload-input {\n  display: none;\n}\n\n.photo-guidance {\n  background: #faf6f5;\n  border-radius: 8px;\n  padding: 12px;\n  margin-top: 16px;\n  font-size: 13px;\n  color: #666;\n}\n\n.photo-guidance-title {\n  font-weight: 600;\n  margin: 0 0 4px 0;\n  color: #3d2b2b;\n}\n\n.preview-container {\n  margin-top: 16px;\n}\n\n.preview-image {\n  width: 100%;\n  max-height: 300px;\n  object-fit: contain;\n  border-radius: 8px;\n  border: 1px solid #e8ddd9;\n}\n\n.preview-actions {\n  display: flex;\n  gap: 12px;\n  margin-top: 16px;\n}\n\n/* Selectors View */\n.selectors-content {\n  padding: 4px 0;\n}\n\n.selectors-loading {\n  text-align: center;\n  padding: 40px 20px;\n  color: #666;\n  font-size: 14px;\n}\n\n.selectors-loading p {\n  margin: 0;\n}\n\n.selector-section {\n  margin-bottom: 20px;\n}\n\n.selector-label {\n  font-weight: 600;\n  font-size: 14px;\n  margin: 0 0 10px 0;\n  color: #3d2b2b;\n}\n\n.selector-value {\n  font-weight: 400;\n  color: #9b6b6b;\n}\n\n.shade-grid {\n  display: flex;\n  flex-wrap: wrap;\n  gap: 10px;\n}\n\n.shade-swatch {\n  width: 36px;\n  height: 36px;\n  border-radius: 50%;\n  border: 3px solid transparent;\n  cursor: pointer;\n  transition: border-color 0.15s, transform 0.1s;\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);\n  padding: 0;\n}\n\n.shade-swatch:hover {\n  transform: scale(1.1);\n}\n\n.shade-swatch.selected {\n  border-color: #3d2b2b;\n  transform: scale(1.1);\n}\n\n.option-group {\n  display: flex;\n  flex-wrap: wrap;\n  gap: 8px;\n}\n\n.option-btn {\n  padding: 10px 16px;\n  border-radius: 8px;\n  border: 1px solid #d4b8b8;\n  background: #fff;\n  cursor: pointer;\n  transition: border-color 0.15s, background 0.15s;\n  text-align: center;\n}\n\n.option-btn:hover {\n  border-color: #9b6b6b;\n  background: #faf6f5;\n}\n\n.option-btn.selected {\n  border-color: #9b6b6b;\n  background: #9b6b6b;\n  color: #fff;\n}\n\n.option-btn-primary {\n  display: block;\n  font-weight: 600;\n  font-size: 14px;\n}\n\n.option-btn-secondary {\n  display: block;\n  font-size: 11px;\n  opacity: 0.7;\n  margin-top: 2px;\n}\n\n.selectors-actions {\n  display: flex;\n  gap: 12px;\n  margin-top: 24px;\n}\n\n.selectors-actions .btn-primary {\n  flex: 1;\n}\n\n/* Progress View */\n.progress-content {\n  text-align: center;\n  padding: 40px 20px;\n}\n\n.spinner {\n  width: 48px;\n  height: 48px;\n  border: 3px solid #f0e4e0;\n  border-top-color: #9b6b6b;\n  border-radius: 50%;\n  animation: spin 0.8s linear infinite;\n  margin: 0 auto 20px;\n}\n\n@keyframes spin {\n  to { transform: rotate(360deg); }\n}\n\n.progress-text {\n  font-weight: 500;\n  margin: 0 0 8px 0;\n}\n\n.progress-subtext {\n  color: #666;\n  font-size: 14px;\n  margin: 0;\n}\n\n.cancel-btn {\n  margin-top: 24px;\n}\n\n/* Result View */\n.result-content {\n  text-align: center;\n}\n\n.result-selection-bar {\n  display: flex;\n  gap: 8px;\n  justify-content: center;\n  margin-bottom: 16px;\n  flex-wrap: wrap;\n}\n\n.result-selection-chip {\n  display: inline-block;\n  padding: 4px 10px;\n  background: #f5f0ee;\n  border-radius: 6px;\n  font-size: 12px;\n  font-weight: 500;\n  color: #3d2b2b;\n}\n\n.result-view-tabs {\n  display: flex;\n  gap: 0;\n  margin-bottom: 12px;\n  border-radius: 8px;\n  background: #f5f0ee;\n  padding: 3px;\n}\n\n.result-view-tab {\n  flex: 1;\n  padding: 8px 12px;\n  border: none;\n  background: transparent;\n  border-radius: 6px;\n  font-size: 13px;\n  font-weight: 500;\n  color: #6b5454;\n  cursor: pointer;\n  transition: background 0.15s, color 0.15s;\n}\n\n.result-view-tab.active {\n  background: #fff;\n  color: #3d2b2b;\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);\n}\n\n/* Before/After Slider */\n.before-after-container {\n  position: relative;\n  overflow: hidden;\n  border-radius: 8px;\n  cursor: col-resize;\n  user-select: none;\n  -webkit-user-select: none;\n  touch-action: none;\n}\n\n.before-after-before {\n  position: absolute;\n  inset: 0;\n  width: 50%;\n  overflow: hidden;\n  z-index: 1;\n}\n\n.before-after-after {\n  position: relative;\n}\n\n.before-after-img {\n  display: block;\n  width: 100%;\n  max-height: 400px;\n  object-fit: contain;\n  pointer-events: none;\n}\n\n.before-after-before .before-after-img {\n  width: 100%;\n  min-width: 0;\n  /* Match the after image's rendered size by using the container's full width */\n  position: absolute;\n  top: 0;\n  left: 0;\n  height: 100%;\n  object-fit: contain;\n}\n\n.before-after-label {\n  position: absolute;\n  bottom: 10px;\n  padding: 4px 10px;\n  background: rgba(0, 0, 0, 0.6);\n  color: #fff;\n  font-size: 11px;\n  font-weight: 600;\n  border-radius: 4px;\n  text-transform: uppercase;\n  letter-spacing: 0.5px;\n  z-index: 2;\n}\n\n.before-label {\n  left: 10px;\n}\n\n.after-label {\n  right: 10px;\n}\n\n.before-after-handle {\n  position: absolute;\n  top: 0;\n  bottom: 0;\n  left: 50%;\n  width: 4px;\n  margin-left: -2px;\n  background: #fff;\n  box-shadow: 0 0 4px rgba(0, 0, 0, 0.3);\n  z-index: 3;\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  justify-content: center;\n}\n\n.before-after-handle-line {\n  width: 2px;\n  flex: 1;\n  background: #fff;\n}\n\n.before-after-handle-grip {\n  width: 28px;\n  height: 28px;\n  background: #fff;\n  border-radius: 50%;\n  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  flex-shrink: 0;\n}\n\n.before-after-handle-grip::before {\n  content: '\\\\2194';\n  font-size: 14px;\n  color: #3d2b2b;\n}\n\n/* Full result image (non-slider view) */\n.result-image-container {\n  position: relative;\n}\n\n.result-image {\n  width: 100%;\n  max-height: 400px;\n  object-fit: contain;\n  border-radius: 8px;\n}\n\n.result-actions {\n  display: flex;\n  gap: 10px;\n  margin-top: 20px;\n  justify-content: center;\n  flex-wrap: wrap;\n}\n\n/* Toast notification */\n.result-toast {\n  position: fixed;\n  bottom: 24px;\n  left: 50%;\n  transform: translateX(-50%) translateY(20px);\n  background: #3d2b2b;\n  color: #fff;\n  padding: 10px 20px;\n  border-radius: 8px;\n  font-size: 14px;\n  font-weight: 500;\n  opacity: 0;\n  transition: opacity 0.2s, transform 0.2s;\n  z-index: 10;\n  pointer-events: none;\n}\n\n.result-toast.visible {\n  opacity: 1;\n  transform: translateX(-50%) translateY(0);\n}\n\n/* Error View */\n.error-content {\n  text-align: center;\n  padding: 20px;\n}\n\n.error-icon {\n  font-size: 48px;\n  margin-bottom: 16px;\n}\n\n.error-title {\n  font-size: 18px;\n  font-weight: 600;\n  margin: 0 0 8px 0;\n  color: #3d2b2b;\n}\n\n.error-text {\n  color: #666;\n  margin: 0 0 20px 0;\n}\n\n/* Buttons */\n.btn {\n  padding: 12px 24px;\n  border-radius: 8px;\n  border: none;\n  font-size: 14px;\n  font-weight: 500;\n  cursor: pointer;\n  transition: background 0.15s, transform 0.1s;\n}\n\n.btn:active {\n  transform: scale(0.98);\n}\n\n.btn-primary {\n  background: #9b6b6b;\n  color: #fff;\n}\n\n.btn-primary:hover {\n  background: #7d5555;\n}\n\n.btn-secondary {\n  background: #f5f0ee;\n  color: #3d2b2b;\n}\n\n.btn-secondary:hover {\n  background: #e8ddd9;\n}\n\n.btn-success {\n  background: #6b8f6b;\n  color: #fff;\n}\n\n.btn-success:hover {\n  background: #567856;\n}\n\n.btn-outline {\n  background: transparent;\n  color: #9b6b6b;\n  border: 1px solid #d4b8b8;\n}\n\n.btn-outline:hover {\n  background: #faf6f5;\n}\n\n.btn:disabled {\n  opacity: 0.6;\n  cursor: not-allowed;\n}\n\n/* ── Mobile Responsive ── */\n@media (max-width: 480px) {\n  .modal {\n    width: 100vw;\n    max-height: 100vh;\n    border-radius: 12px 12px 0 0;\n    padding: 16px;\n    margin-top: auto;\n  }\n\n  .backdrop {\n    align-items: flex-end;\n  }\n\n  .title {\n    font-size: 17px;\n  }\n\n  .header {\n    margin-bottom: 14px;\n  }\n\n  /* Upload */\n  .upload-zone {\n    padding: 24px 16px;\n  }\n\n  .capture-tabs {\n    margin-bottom: 12px;\n  }\n\n  .capture-tab {\n    padding: 8px 12px;\n    font-size: 13px;\n  }\n\n  /* Camera */\n  .camera-viewfinder {\n    aspect-ratio: 3/4;\n  }\n\n  /* Selectors */\n  .shade-swatch {\n    width: 40px;\n    height: 40px;\n  }\n\n  .shade-grid {\n    gap: 8px;\n  }\n\n  .option-btn {\n    padding: 8px 12px;\n  }\n\n  .selectors-actions {\n    flex-direction: column;\n  }\n\n  .selectors-actions .btn {\n    width: 100%;\n  }\n\n  /* Result */\n  .result-actions {\n    flex-direction: column;\n    gap: 8px;\n  }\n\n  .result-actions .btn {\n    width: 100%;\n  }\n\n  .result-view-tabs {\n    margin-bottom: 8px;\n  }\n\n  .before-after-img {\n    max-height: 300px;\n  }\n\n  .result-image {\n    max-height: 300px;\n  }\n\n  .result-selection-bar {\n    gap: 6px;\n  }\n\n  /* Consent */\n  .consent-actions {\n    flex-direction: column;\n  }\n\n  .consent-actions .btn {\n    width: 100%;\n  }\n\n  /* Preview */\n  .preview-actions {\n    flex-direction: column;\n  }\n\n  .preview-actions .btn {\n    width: 100%;\n  }\n\n  /* Buttons slightly larger tap targets */\n  .btn {\n    padding: 14px 24px;\n    font-size: 15px;\n  }\n}\n`;\n","export type View = 'closed' | 'consent' | 'selectors' | 'upload' | 'processing' | 'result' | 'error';\n\nexport type Shade = {\n  id: string;\n  name: string;\n  hexColor: string;\n  shopifyVariantId?: string | null;\n};\n\nexport type Length = {\n  id: string;\n  label: string;\n  inches: number;\n  bodyLandmark: string;\n};\n\nexport type Texture = {\n  id: string;\n  name: string;\n};\n\nexport type TryOnResult = {\n  imageBase64: string;\n  mimeType: string;\n};\n\nexport type Catalog = {\n  shades: Shade[];\n  lengths: Length[];\n  textures: Texture[];\n  loaded: boolean;\n};\n\nexport type State = {\n  view: View;\n  userPhoto: File | null;\n  originalImage: string | null; // data URL of user's original photo\n  selectedShade: Shade | null;\n  selectedLength: Length | null;\n  selectedTexture: Texture | null;\n  catalog: Catalog;\n  result: TryOnResult | null;\n  error: string | null;\n  progress: string;\n  productId?: string;\n};\n\ntype Listener = (state: State) => void;\n\nconst initialState: State = {\n  view: 'closed',\n  userPhoto: null,\n  originalImage: null,\n  selectedShade: null,\n  selectedLength: null,\n  selectedTexture: null,\n  catalog: { shades: [], lengths: [], textures: [], loaded: false },\n  result: null,\n  error: null,\n  progress: '',\n  productId: undefined,\n};\n\nlet state: State = { ...initialState };\nconst listeners: Set<Listener> = new Set();\n\nexport function getState(): State {\n  return state;\n}\n\nexport function setState(partial: Partial<State>): void {\n  state = { ...state, ...partial };\n  listeners.forEach(listener => listener(state));\n}\n\nexport function resetState(): void {\n  state = { ...initialState };\n  listeners.forEach(listener => listener(state));\n}\n\nexport function subscribe(listener: Listener): () => void {\n  listeners.add(listener);\n  return () => listeners.delete(listener);\n}\n\nexport function openWidget(productId?: string): void {\n  const hasConsent = localStorage.getItem('tryon-consent') === 'true';\n  setState({\n    view: hasConsent ? 'upload' : 'consent',\n    productId,\n    result: null,\n    error: null,\n    progress: '',\n  });\n}\n\nexport function closeWidget(): void {\n  setState({ view: 'closed' });\n}\n\nexport function setConsent(accepted: boolean): void {\n  if (accepted) {\n    localStorage.setItem('tryon-consent', 'true');\n    setState({ view: 'upload' });\n  } else {\n    closeWidget();\n  }\n}\n\nexport function setUserPhoto(file: File): void {\n  setState({ userPhoto: file });\n}\n\nexport function startProcessing(): void {\n  setState({ view: 'processing', progress: 'Uploading...', error: null });\n}\n\nexport function setProgress(progress: string): void {\n  setState({ progress });\n}\n\nexport function setResult(result: TryOnResult): void {\n  setState({ view: 'result', result });\n}\n\nexport function setError(error: string): void {\n  setState({ view: 'error', error });\n}\n\nexport function retryWithSamePhoto(): void {\n  setState({ view: 'upload', error: null, result: null });\n}\n\nexport function tryAnotherShade(): void {\n  setState({ view: 'selectors', error: null, result: null, selectedShade: null });\n}\n","export interface WidgetConfig {\n  apiBaseUrl: string;\n  privacyPolicyUrl: string;\n}\n\nconst defaultConfig: WidgetConfig = {\n  apiBaseUrl: 'http://localhost:8787',\n  privacyPolicyUrl: '#',\n};\n\nlet config: WidgetConfig = { ...defaultConfig };\n\nexport function getConfig(): WidgetConfig {\n  return config;\n}\n\nexport function setConfig(newConfig: Partial<WidgetConfig>): void {\n  config = { ...config, ...newConfig };\n}\n","import { setConsent, closeWidget } from '../state';\nimport { getConfig } from '../config';\n\nexport function renderConsent(container: HTMLElement): void {\n  const config = getConfig();\n  const privacyUrl = config.privacyPolicyUrl || '#';\n\n  container.innerHTML = `\n    <div class=\"consent-content\">\n      <div class=\"consent-icon\">&#128135;</div>\n      <h3 class=\"consent-title\">Photo Permission</h3>\n      <p class=\"consent-text\">\n        To show you how our hair extensions will look, we need to process your photo.\n        Your photo is used only for this try-on and is not stored.\n      </p>\n      <p class=\"consent-text\">\n        <a href=\"${escapeAttr(privacyUrl)}\" target=\"_blank\" rel=\"noopener\" class=\"consent-link\">\n          View Privacy Policy\n        </a>\n      </p>\n      <div class=\"consent-actions\">\n        <button class=\"btn btn-primary\" id=\"consent-accept\">I Agree</button>\n        <button class=\"btn btn-secondary\" id=\"consent-decline\">No Thanks</button>\n      </div>\n    </div>\n  `;\n\n  container.querySelector('#consent-accept')?.addEventListener('click', () => {\n    setConsent(true);\n  });\n\n  container.querySelector('#consent-decline')?.addEventListener('click', () => {\n    setConsent(false);\n  });\n}\n\nfunction escapeAttr(text: string): string {\n  return text.replace(/\"/g, '&quot;').replace(/'/g, '&#39;');\n}\n","const MAX_DIMENSION = 2048;\nconst MAX_BYTES = 2_000_000;\nconst INITIAL_QUALITY = 0.9;\nconst MIN_QUALITY = 0.5;\nconst QUALITY_STEP = 0.1;\n\nexport async function compressImage(file: File | Blob, maxBytes = MAX_BYTES): Promise<Blob> {\n  const img = await loadImage(file);\n\n  // Calculate resize dimensions\n  let { width, height } = img;\n  if (width > MAX_DIMENSION || height > MAX_DIMENSION) {\n    const ratio = Math.min(MAX_DIMENSION / width, MAX_DIMENSION / height);\n    width = Math.round(width * ratio);\n    height = Math.round(height * ratio);\n  }\n\n  // Create canvas and draw resized image\n  const canvas = document.createElement('canvas');\n  canvas.width = width;\n  canvas.height = height;\n  const ctx = canvas.getContext('2d');\n  if (!ctx) throw new Error('Failed to get canvas context');\n\n  ctx.drawImage(img, 0, 0, width, height);\n\n  // Try to get under maxBytes with quality reduction\n  let quality = INITIAL_QUALITY;\n  let blob = await canvasToBlob(canvas, 'image/jpeg', quality);\n\n  while (blob.size > maxBytes && quality > MIN_QUALITY) {\n    quality -= QUALITY_STEP;\n    blob = await canvasToBlob(canvas, 'image/jpeg', quality);\n  }\n\n  // If still too large, resize further\n  if (blob.size > maxBytes) {\n    const ratio = Math.sqrt(maxBytes / blob.size) * 0.9;\n    canvas.width = Math.round(width * ratio);\n    canvas.height = Math.round(height * ratio);\n    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);\n    blob = await canvasToBlob(canvas, 'image/jpeg', MIN_QUALITY);\n  }\n\n  return blob;\n}\n\nfunction loadImage(file: File | Blob): Promise<HTMLImageElement> {\n  return new Promise((resolve, reject) => {\n    const img = new Image();\n    const url = URL.createObjectURL(file);\n\n    img.onload = () => {\n      URL.revokeObjectURL(url);\n      resolve(img);\n    };\n\n    img.onerror = () => {\n      URL.revokeObjectURL(url);\n      reject(new Error('Failed to load image'));\n    };\n\n    img.src = url;\n  });\n}\n\nfunction canvasToBlob(canvas: HTMLCanvasElement, type: string, quality: number): Promise<Blob> {\n  return new Promise((resolve, reject) => {\n    canvas.toBlob(\n      (blob) => {\n        if (blob) resolve(blob);\n        else reject(new Error('Failed to create blob'));\n      },\n      type,\n      quality\n    );\n  });\n}\n","/**\n * Read EXIF orientation from JPEG and auto-rotate if needed\n */\nexport async function fixOrientation(file: File): Promise<Blob> {\n  // Only process JPEG files\n  if (!file.type.includes('jpeg') && !file.type.includes('jpg')) {\n    return file;\n  }\n\n  const orientation = await getExifOrientation(file);\n\n  // No rotation needed\n  if (orientation <= 1) {\n    return file;\n  }\n\n  return rotateImage(file, orientation);\n}\n\nasync function getExifOrientation(file: File): Promise<number> {\n  try {\n    const buffer = await file.slice(0, 65536).arrayBuffer();\n    const view = new DataView(buffer);\n\n    // Check for JPEG marker\n    if (view.getUint16(0) !== 0xFFD8) {\n      return 1;\n    }\n\n    let offset = 2;\n    while (offset < view.byteLength - 2) {\n      const marker = view.getUint16(offset);\n      offset += 2;\n\n      // APP1 marker (EXIF)\n      if (marker === 0xFFE1) {\n        const length = view.getUint16(offset);\n        offset += 2;\n\n        // Check for \"Exif\\0\\0\"\n        const exifHeader = String.fromCharCode(\n          view.getUint8(offset),\n          view.getUint8(offset + 1),\n          view.getUint8(offset + 2),\n          view.getUint8(offset + 3)\n        );\n        if (exifHeader !== 'Exif') {\n          return 1;\n        }\n        offset += 6;\n\n        // TIFF header\n        const littleEndian = view.getUint16(offset) === 0x4949;\n        offset += 2;\n\n        // Skip TIFF magic number\n        offset += 2;\n\n        // IFD0 offset\n        const ifdOffset = view.getUint32(offset, littleEndian);\n        offset = offset - 4 + ifdOffset;\n\n        // Number of entries\n        const numEntries = view.getUint16(offset, littleEndian);\n        offset += 2;\n\n        // Search for orientation tag (0x0112)\n        for (let i = 0; i < numEntries; i++) {\n          const tag = view.getUint16(offset, littleEndian);\n          if (tag === 0x0112) {\n            return view.getUint16(offset + 8, littleEndian);\n          }\n          offset += 12;\n        }\n\n        return 1;\n      } else if ((marker & 0xFF00) === 0xFF00) {\n        // Skip other markers\n        offset += view.getUint16(offset);\n      } else {\n        break;\n      }\n    }\n\n    return 1;\n  } catch {\n    return 1;\n  }\n}\n\nasync function rotateImage(file: File, orientation: number): Promise<Blob> {\n  const img = await loadImage(file);\n  const canvas = document.createElement('canvas');\n  const ctx = canvas.getContext('2d');\n  if (!ctx) throw new Error('Failed to get canvas context');\n\n  let width = img.width;\n  let height = img.height;\n\n  // Swap dimensions for 90/270 degree rotations\n  if (orientation >= 5 && orientation <= 8) {\n    canvas.width = height;\n    canvas.height = width;\n  } else {\n    canvas.width = width;\n    canvas.height = height;\n  }\n\n  // Apply transformation based on orientation\n  switch (orientation) {\n    case 2: // Horizontal flip\n      ctx.scale(-1, 1);\n      ctx.translate(-width, 0);\n      break;\n    case 3: // 180 degree rotation\n      ctx.rotate(Math.PI);\n      ctx.translate(-width, -height);\n      break;\n    case 4: // Vertical flip\n      ctx.scale(1, -1);\n      ctx.translate(0, -height);\n      break;\n    case 5: // 90 CW + horizontal flip\n      ctx.rotate(0.5 * Math.PI);\n      ctx.scale(1, -1);\n      break;\n    case 6: // 90 CW\n      ctx.rotate(0.5 * Math.PI);\n      ctx.translate(0, -height);\n      break;\n    case 7: // 90 CCW + horizontal flip\n      ctx.rotate(-0.5 * Math.PI);\n      ctx.translate(-width, 0);\n      ctx.scale(1, -1);\n      break;\n    case 8: // 90 CCW\n      ctx.rotate(-0.5 * Math.PI);\n      ctx.translate(-width, 0);\n      break;\n  }\n\n  ctx.drawImage(img, 0, 0);\n\n  return new Promise((resolve, reject) => {\n    canvas.toBlob(\n      (blob) => {\n        if (blob) resolve(blob);\n        else reject(new Error('Failed to create rotated image'));\n      },\n      'image/jpeg',\n      0.95\n    );\n  });\n}\n\nfunction loadImage(file: File): Promise<HTMLImageElement> {\n  return new Promise((resolve, reject) => {\n    const img = new Image();\n    const url = URL.createObjectURL(file);\n\n    img.onload = () => {\n      URL.revokeObjectURL(url);\n      resolve(img);\n    };\n\n    img.onerror = () => {\n      URL.revokeObjectURL(url);\n      reject(new Error('Failed to load image'));\n    };\n\n    img.src = url;\n  });\n}\n","const ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/webp'];\nconst MIN_DIMENSION = 512;\nconst MAX_FILE_SIZE = 20 * 1024 * 1024; // 20MB\n\nexport class ValidationError extends Error {\n  constructor(message: string) {\n    super(message);\n    this.name = 'ValidationError';\n  }\n}\n\nexport function validateImage(file: File): void {\n  // Check file type\n  if (!ALLOWED_TYPES.includes(file.type)) {\n    throw new ValidationError(\n      'Please upload a JPEG, PNG, or WebP image.'\n    );\n  }\n\n  // Check file size\n  if (file.size > MAX_FILE_SIZE) {\n    throw new ValidationError(\n      'Image is too large. Please upload an image under 20MB.'\n    );\n  }\n}\n\nexport async function validateDimensions(file: File): Promise<void> {\n  const dimensions = await getImageDimensions(file);\n\n  if (dimensions.width < MIN_DIMENSION || dimensions.height < MIN_DIMENSION) {\n    throw new ValidationError(\n      `Image is too small. Minimum size is ${MIN_DIMENSION}x${MIN_DIMENSION} pixels.`\n    );\n  }\n}\n\nfunction getImageDimensions(file: File): Promise<{ width: number; height: number }> {\n  return new Promise((resolve, reject) => {\n    const img = new Image();\n    const url = URL.createObjectURL(file);\n\n    img.onload = () => {\n      URL.revokeObjectURL(url);\n      resolve({ width: img.width, height: img.height });\n    };\n\n    img.onerror = () => {\n      URL.revokeObjectURL(url);\n      reject(new ValidationError('Failed to load image. Please try another file.'));\n    };\n\n    img.src = url;\n  });\n}\n","import { setState } from '../state';\nimport { compressImage } from '../utils/compression';\n\nlet stream: MediaStream | null = null;\nlet videoEl: HTMLVideoElement | null = null;\n\nexport function renderCamera(container: HTMLElement, onCapture: (previewUrl: string) => void): void {\n  container.innerHTML = `\n    <div class=\"camera-container\">\n      <div class=\"camera-viewfinder\" id=\"camera-viewfinder\">\n        <video id=\"camera-video\" autoplay playsinline muted class=\"camera-video\"></video>\n        <div class=\"camera-loading\" id=\"camera-loading\">\n          <div class=\"spinner\"></div>\n          <p>Starting camera...</p>\n        </div>\n      </div>\n      <div class=\"camera-actions\">\n        <button class=\"btn btn-primary camera-capture-btn\" id=\"camera-capture\" disabled>Capture Photo</button>\n      </div>\n    </div>\n  `;\n\n  const video = container.querySelector('#camera-video') as HTMLVideoElement;\n  const captureBtn = container.querySelector('#camera-capture') as HTMLButtonElement;\n  const loading = container.querySelector('#camera-loading') as HTMLElement;\n\n  videoEl = video;\n\n  startCamera(video, loading, captureBtn, container, onCapture);\n\n  captureBtn.addEventListener('click', () => {\n    captureSnapshot(video, onCapture);\n  });\n}\n\nasync function startCamera(\n  video: HTMLVideoElement,\n  loading: HTMLElement,\n  captureBtn: HTMLButtonElement,\n  container: HTMLElement,\n  onCapture: (previewUrl: string) => void\n): Promise<void> {\n  try {\n    stream = await navigator.mediaDevices.getUserMedia({\n      video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 960 } },\n      audio: false,\n    });\n\n    video.srcObject = stream;\n    await video.play();\n\n    loading.style.display = 'none';\n    captureBtn.disabled = false;\n  } catch (err: any) {\n    console.error('[TryOn] Camera error:', err);\n    stopCamera();\n\n    let message = 'Unable to access camera.';\n    if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {\n      message = 'Camera permission was denied.';\n    } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {\n      message = 'No camera found on this device.';\n    } else if (err.name === 'NotReadableError') {\n      message = 'Camera is in use by another app.';\n    }\n\n    container.innerHTML = `\n      <div class=\"camera-error\">\n        <div class=\"camera-error-icon\">&#128247;</div>\n        <p class=\"camera-error-title\">${message}</p>\n        <p class=\"camera-error-text\">Please upload a photo instead, or check your browser's camera permissions and try again.</p>\n      </div>\n    `;\n  }\n}\n\nasync function captureSnapshot(video: HTMLVideoElement, onCapture: (previewUrl: string) => void): Promise<void> {\n  const canvas = document.createElement('canvas');\n  canvas.width = video.videoWidth;\n  canvas.height = video.videoHeight;\n\n  const ctx = canvas.getContext('2d');\n  if (!ctx) return;\n\n  // Mirror the image (front-facing camera is mirrored in preview)\n  ctx.translate(canvas.width, 0);\n  ctx.scale(-1, 1);\n  ctx.drawImage(video, 0, 0);\n\n  const blob = await new Promise<Blob>((resolve, reject) => {\n    canvas.toBlob(\n      (b) => (b ? resolve(b) : reject(new Error('Failed to capture'))),\n      'image/jpeg',\n      0.92\n    );\n  });\n\n  // Compress the snapshot\n  const compressed = await compressImage(blob);\n\n  // Stop camera now that we have the photo\n  stopCamera();\n\n  // Create preview URL and store in state (including original for before/after)\n  const previewUrl = URL.createObjectURL(compressed);\n  const originalImage = await blobToDataUrl(compressed);\n  setState({\n    userPhoto: new File([compressed], 'camera-capture.jpg', { type: 'image/jpeg' }),\n    originalImage,\n  });\n\n  onCapture(previewUrl);\n}\n\nexport function stopCamera(): void {\n  if (stream) {\n    stream.getTracks().forEach((track) => track.stop());\n    stream = null;\n  }\n  if (videoEl) {\n    videoEl.srcObject = null;\n    videoEl = null;\n  }\n}\n\nfunction blobToDataUrl(blob: Blob): Promise<string> {\n  return new Promise((resolve, reject) => {\n    const reader = new FileReader();\n    reader.onload = () => resolve(reader.result as string);\n    reader.onerror = () => reject(new Error('Failed to read image'));\n    reader.readAsDataURL(blob);\n  });\n}\n","import { getState, setState } from '../state';\nimport { compressImage } from '../utils/compression';\nimport { fixOrientation } from '../utils/exif';\nimport { validateImage, ValidationError } from '../utils/validation';\nimport { renderCamera, stopCamera } from './Camera';\n\nlet previewUrl: string | null = null;\nlet activeTab: 'upload' | 'camera' = 'upload';\n\nexport function renderUpload(container: HTMLElement, shadowRoot: ShadowRoot): void {\n  const state = getState();\n  const hasPhoto = state.userPhoto !== null;\n\n  if (hasPhoto) {\n    // Regenerate preview URL if needed (e.g., returning from result view)\n    if (!previewUrl && state.userPhoto) {\n      previewUrl = URL.createObjectURL(state.userPhoto);\n    }\n    if (previewUrl) {\n      renderPreview(container, previewUrl);\n      return;\n    }\n  }\n\n  renderCaptureTabs(container, shadowRoot);\n}\n\nfunction renderCaptureTabs(container: HTMLElement, shadowRoot: ShadowRoot): void {\n  const hasCamera = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);\n\n  if (!hasCamera) {\n    // No camera support — render dropzone directly without tabs\n    renderDropzone(container, shadowRoot);\n    return;\n  }\n\n  container.innerHTML = `\n    <div class=\"capture-tabs\">\n      <button class=\"capture-tab ${activeTab === 'upload' ? 'active' : ''}\" id=\"tab-upload\">Upload Photo</button>\n      <button class=\"capture-tab ${activeTab === 'camera' ? 'active' : ''}\" id=\"tab-camera\">Use Camera</button>\n    </div>\n    <div id=\"capture-content\"></div>\n    <div class=\"photo-guidance\">\n      <p class=\"photo-guidance-title\">For best results:</p>\n      Face the camera with your hair down in good lighting. A clear view of your head and shoulders gives the most realistic result.\n    </div>\n  `;\n\n  const content = container.querySelector('#capture-content') as HTMLElement;\n  const tabUpload = container.querySelector('#tab-upload') as HTMLButtonElement;\n  const tabCamera = container.querySelector('#tab-camera') as HTMLButtonElement;\n\n  function switchTab(tab: 'upload' | 'camera') {\n    activeTab = tab;\n    tabUpload.classList.toggle('active', tab === 'upload');\n    tabCamera.classList.toggle('active', tab === 'camera');\n\n    if (tab === 'upload') {\n      stopCamera();\n      renderDropzoneInto(content, container, shadowRoot);\n    } else {\n      renderCamera(content, (url) => {\n        previewUrl = url;\n        renderPreview(container, url);\n      });\n    }\n  }\n\n  tabUpload.addEventListener('click', () => switchTab('upload'));\n  tabCamera.addEventListener('click', () => switchTab('camera'));\n\n  // Render initial tab\n  if (activeTab === 'camera') {\n    renderCamera(content, (url) => {\n      previewUrl = url;\n      renderPreview(container, url);\n    });\n  } else {\n    renderDropzoneInto(content, container, shadowRoot);\n  }\n}\n\nfunction renderDropzoneInto(target: HTMLElement, container: HTMLElement, shadowRoot: ShadowRoot): void {\n  target.innerHTML = `\n    <div class=\"upload-zone\" id=\"upload-zone\">\n      <div class=\"upload-icon\">&#128247;</div>\n      <p class=\"upload-title\">Upload your photo</p>\n      <p class=\"upload-subtitle\">Drag & drop or click to select</p>\n      <input type=\"file\" accept=\"image/jpeg,image/png,image/webp\" capture=\"user\" class=\"upload-input\" id=\"upload-input\" />\n    </div>\n  `;\n\n  const zone = target.querySelector('#upload-zone') as HTMLElement;\n  const input = target.querySelector('#upload-input') as HTMLInputElement;\n\n  zone.addEventListener('click', () => input.click());\n\n  zone.addEventListener('dragover', (e) => {\n    e.preventDefault();\n    zone.classList.add('dragover');\n  });\n\n  zone.addEventListener('dragleave', () => {\n    zone.classList.remove('dragover');\n  });\n\n  zone.addEventListener('drop', (e) => {\n    e.preventDefault();\n    zone.classList.remove('dragover');\n    const file = e.dataTransfer?.files[0];\n    if (file) handleFile(file, container, shadowRoot);\n  });\n\n  input.addEventListener('change', () => {\n    const file = input.files?.[0];\n    if (file) handleFile(file, container, shadowRoot);\n  });\n}\n\nfunction renderDropzone(container: HTMLElement, shadowRoot: ShadowRoot): void {\n  container.innerHTML = `\n    <div class=\"upload-zone\" id=\"upload-zone\">\n      <div class=\"upload-icon\">&#128247;</div>\n      <p class=\"upload-title\">Upload your photo</p>\n      <p class=\"upload-subtitle\">Drag & drop or click to select</p>\n      <input type=\"file\" accept=\"image/jpeg,image/png,image/webp\" capture=\"user\" class=\"upload-input\" id=\"upload-input\" />\n    </div>\n    <div class=\"photo-guidance\">\n      <p class=\"photo-guidance-title\">For best results:</p>\n      Face the camera with your hair down in good lighting. A clear view of your head and shoulders gives the most realistic result.\n    </div>\n  `;\n\n  const zone = container.querySelector('#upload-zone') as HTMLElement;\n  const input = container.querySelector('#upload-input') as HTMLInputElement;\n\n  zone.addEventListener('click', () => input.click());\n\n  zone.addEventListener('dragover', (e) => {\n    e.preventDefault();\n    zone.classList.add('dragover');\n  });\n\n  zone.addEventListener('dragleave', () => {\n    zone.classList.remove('dragover');\n  });\n\n  zone.addEventListener('drop', (e) => {\n    e.preventDefault();\n    zone.classList.remove('dragover');\n    const file = e.dataTransfer?.files[0];\n    if (file) handleFile(file, container, shadowRoot);\n  });\n\n  input.addEventListener('change', () => {\n    const file = input.files?.[0];\n    if (file) handleFile(file, container, shadowRoot);\n  });\n}\n\nasync function handleFile(file: File, container: HTMLElement, shadowRoot: ShadowRoot): Promise<void> {\n  try {\n    // Validate\n    validateImage(file);\n\n    // Fix EXIF orientation\n    const oriented = await fixOrientation(file);\n\n    // Compress if needed\n    const compressed = await compressImage(oriented);\n\n    // Create preview URL\n    if (previewUrl) URL.revokeObjectURL(previewUrl);\n    previewUrl = URL.createObjectURL(compressed);\n\n    // Store in state (including original image data URL for before/after)\n    const originalImage = await blobToDataUrl(compressed);\n    setState({\n      userPhoto: new File([compressed], file.name, { type: compressed.type }),\n      originalImage,\n    });\n\n    // Re-render with preview\n    renderPreview(container, previewUrl);\n  } catch (err) {\n    if (err instanceof ValidationError) {\n      alert(err.message);\n    } else {\n      console.error('[TryOn] Error processing image:', err);\n      alert('Failed to process image. Please try another photo.');\n    }\n  }\n}\n\nfunction renderPreview(container: HTMLElement, url: string): void {\n  container.innerHTML = `\n    <div class=\"preview-container\">\n      <img src=\"${url}\" alt=\"Your photo\" class=\"preview-image\" />\n      <div class=\"preview-actions\">\n        <button class=\"btn btn-primary\" id=\"preview-submit\">Choose Extensions</button>\n        <button class=\"btn btn-secondary\" id=\"preview-retake\">Choose Different</button>\n      </div>\n    </div>\n  `;\n\n  container.querySelector('#preview-submit')?.addEventListener('click', () => {\n    setState({ view: 'selectors' });\n  });\n  container.querySelector('#preview-retake')?.addEventListener('click', () => {\n    if (previewUrl) {\n      URL.revokeObjectURL(previewUrl);\n      previewUrl = null;\n    }\n    setState({ userPhoto: null });\n  });\n}\n\nexport function cleanupUpload(): void {\n  stopCamera();\n  if (previewUrl) {\n    URL.revokeObjectURL(previewUrl);\n    previewUrl = null;\n  }\n}\n\nfunction blobToDataUrl(blob: Blob): Promise<string> {\n  return new Promise((resolve, reject) => {\n    const reader = new FileReader();\n    reader.onload = () => resolve(reader.result as string);\n    reader.onerror = () => reject(new Error('Failed to read image'));\n    reader.readAsDataURL(blob);\n  });\n}\n","import { getState, setError, closeWidget } from '../state';\n\nlet abortController: AbortController | null = null;\nlet slowTimer: ReturnType<typeof setTimeout> | null = null;\n\nexport function renderProgress(container: HTMLElement): void {\n  const state = getState();\n\n  container.innerHTML = `\n    <div class=\"progress-content\">\n      <div class=\"spinner\"></div>\n      <p class=\"progress-text\" id=\"progress-text\">${escapeHtml(state.progress || 'Processing...')}</p>\n      <p class=\"progress-subtext\" id=\"progress-subtext\">This may take up to a minute</p>\n      <button class=\"btn btn-secondary cancel-btn\" id=\"progress-cancel\">Cancel</button>\n    </div>\n  `;\n\n  // Show \"taking longer\" message after 30s\n  clearSlowTimer();\n  slowTimer = setTimeout(() => {\n    const subtext = container.querySelector('#progress-subtext');\n    if (subtext) {\n      subtext.textContent = 'Taking longer than usual, please wait...';\n    }\n  }, 30000);\n\n  container.querySelector('#progress-cancel')?.addEventListener('click', () => {\n    cancelProcessing();\n    closeWidget();\n  });\n}\n\nexport function getAbortController(): AbortController {\n  if (abortController) {\n    abortController.abort();\n  }\n  abortController = new AbortController();\n  return abortController;\n}\n\nexport function cancelProcessing(): void {\n  if (abortController) {\n    abortController.abort();\n    abortController = null;\n  }\n  clearSlowTimer();\n}\n\nfunction clearSlowTimer(): void {\n  if (slowTimer) {\n    clearTimeout(slowTimer);\n    slowTimer = null;\n  }\n}\n\nfunction escapeHtml(text: string): string {\n  const div = document.createElement('div');\n  div.textContent = text;\n  return div.innerHTML;\n}\n","import { getConfig } from '../config';\nimport { getAbortController, cancelProcessing } from '../components/Progress';\nimport type { Shade, Length, Texture, Catalog } from '../state';\n\nconst CLIENT_TIMEOUT = 90_000; // 90 seconds\n\nlet catalogCache: Catalog | null = null;\n\nexport interface TryOnResult {\n  imageBase64: string;\n  mimeType: string;\n}\n\nexport async function fetchCatalog(): Promise<Catalog> {\n  if (catalogCache && catalogCache.loaded) {\n    return catalogCache;\n  }\n\n  const config = getConfig();\n  const baseUrl = config.apiBaseUrl;\n\n  const [shadesRes, lengthsRes, texturesRes] = await Promise.all([\n    fetch(`${baseUrl}/api/shades`),\n    fetch(`${baseUrl}/api/lengths`),\n    fetch(`${baseUrl}/api/textures`),\n  ]);\n\n  if (!shadesRes.ok || !lengthsRes.ok || !texturesRes.ok) {\n    throw new Error('Failed to load catalog');\n  }\n\n  const [shadesData, lengthsData, texturesData] = await Promise.all([\n    shadesRes.json(),\n    lengthsRes.json(),\n    texturesRes.json(),\n  ]);\n\n  catalogCache = {\n    shades: shadesData.shades as Shade[],\n    lengths: lengthsData.lengths as Length[],\n    textures: texturesData.textures as Texture[],\n    loaded: true,\n  };\n\n  return catalogCache;\n}\n\nexport interface ApiError {\n  error: string;\n  code: string;\n  retryable: boolean;\n}\n\nexport async function submitTryOn(\n  userPhoto: File,\n  shadeId: string,\n  lengthId: string,\n  textureId: string,\n  onProgress?: (message: string) => void\n): Promise<TryOnResult> {\n  const config = getConfig();\n  const controller = getAbortController();\n\n  // Client-side timeout\n  const timeoutId = setTimeout(() => {\n    controller.abort();\n  }, CLIENT_TIMEOUT);\n\n  try {\n    onProgress?.('Uploading your photo...');\n\n    const formData = new FormData();\n    formData.append('userImage', userPhoto);\n    formData.append('shadeId', shadeId);\n    formData.append('lengthId', lengthId);\n    formData.append('textureId', textureId);\n\n    // Simulate progress stages\n    const progressTimer = setInterval(() => {\n      const messages = [\n        'Analyzing your photo...',\n        'Preparing the extensions...',\n        'Applying your look...',\n        'Almost there...'\n      ];\n      const index = Math.floor(Math.random() * messages.length);\n      onProgress?.(messages[index]);\n    }, 5000);\n\n    const response = await fetch(`${config.apiBaseUrl}/api/tryon`, {\n      method: 'POST',\n      body: formData,\n      signal: controller.signal\n    });\n\n    clearInterval(progressTimer);\n    clearTimeout(timeoutId);\n\n    if (!response.ok) {\n      const errorData = await parseErrorResponse(response);\n\n      let message = errorData.error || 'Try-on failed';\n      if (errorData.code === 'MISSING_SELECTIONS') {\n        message = 'Please select a shade, length, and texture.';\n      } else if (errorData.code === 'TIMEOUT') {\n        message = 'Request timed out. Please try again.';\n      } else if (errorData.code === 'RATE_LIMITED') {\n        message = 'Too many requests. Please wait a moment and try again.';\n      } else if (errorData.code === 'SAFETY_BLOCK') {\n        message = 'Your photo could not be processed. Please try a different photo.';\n      } else if (errorData.code === 'UNSUITABLE_PHOTO') {\n        message = errorData.error || 'This photo may not work well with hair extensions. Please try a photo showing longer hair.';\n      } else if (errorData.code === 'NO_IMAGE') {\n        message = 'The AI could not generate a result. Please try again.';\n      }\n\n      throw new TryOnError(\n        message,\n        errorData.code || 'UNKNOWN',\n        errorData.retryable ?? true\n      );\n    }\n\n    const data = await response.json();\n\n    if (!data.imageBase64) {\n      throw new TryOnError('No image returned', 'NO_IMAGE', true);\n    }\n\n    return {\n      imageBase64: data.imageBase64,\n      mimeType: data.mimeType || 'image/png'\n    };\n  } catch (err: any) {\n    clearTimeout(timeoutId);\n\n    if (err.name === 'AbortError') {\n      throw new TryOnError(\n        'Request timed out. Please try again.',\n        'TIMEOUT',\n        true\n      );\n    }\n\n    if (err instanceof TryOnError) {\n      throw err;\n    }\n\n    throw new TryOnError(\n      'Failed to connect to server. Please check your connection.',\n      'NETWORK_ERROR',\n      true\n    );\n  }\n}\n\nclass TryOnError extends Error {\n  code: string;\n  retryable: boolean;\n\n  constructor(message: string, code: string, retryable: boolean) {\n    super(message);\n    this.name = 'TryOnError';\n    this.code = code;\n    this.retryable = retryable;\n  }\n}\n\nasync function parseErrorResponse(response: Response): Promise<ApiError> {\n  try {\n    return await response.json();\n  } catch {\n    return {\n      error: `Server error (${response.status})`,\n      code: `HTTP_${response.status}`,\n      retryable: response.status >= 500\n    };\n  }\n}\n","import { getState, setState, startProcessing, setProgress, setResult, setError } from '../state';\nimport type { Shade, Length, Texture } from '../state';\nimport { fetchCatalog } from '../services/api';\nimport { submitTryOn } from '../services/api';\n\nexport async function renderSelectors(container: HTMLElement): Promise<void> {\n  const state = getState();\n\n  // Show loading while catalog fetches\n  if (!state.catalog.loaded) {\n    container.innerHTML = `\n      <div class=\"selectors-loading\">\n        <div class=\"spinner\"></div>\n        <p>Loading options...</p>\n      </div>\n    `;\n\n    try {\n      const catalog = await fetchCatalog();\n      setState({ catalog });\n      // Re-render now that catalog is loaded\n      renderSelectorsUI(container);\n    } catch (err) {\n      container.innerHTML = `\n        <div class=\"error-content\">\n          <p class=\"error-text\">Failed to load shade options. Please try again.</p>\n          <button class=\"btn btn-primary\" id=\"catalog-retry\">Retry</button>\n        </div>\n      `;\n      container.querySelector('#catalog-retry')?.addEventListener('click', () => {\n        renderSelectors(container);\n      });\n    }\n    return;\n  }\n\n  renderSelectorsUI(container);\n}\n\nfunction renderSelectorsUI(container: HTMLElement): void {\n  const state = getState();\n  const { shades, lengths, textures } = state.catalog;\n\n  const selectedShade = state.selectedShade;\n  const selectedLength = state.selectedLength;\n  const selectedTexture = state.selectedTexture;\n\n  const allSelected = selectedShade && selectedLength && selectedTexture;\n\n  container.innerHTML = `\n    <div class=\"selectors-content\">\n      <div class=\"selector-section\">\n        <p class=\"selector-label\">Shade${selectedShade ? `: <span class=\"selector-value\">${escapeHtml(selectedShade.name)}</span>` : ''}</p>\n        <div class=\"shade-grid\" id=\"shade-grid\">\n          ${shades.map(shade => `\n            <button\n              class=\"shade-swatch ${selectedShade?.id === shade.id ? 'selected' : ''}\"\n              data-shade-id=\"${shade.id}\"\n              title=\"${escapeHtml(shade.name)}\"\n              style=\"background-color: ${shade.hexColor};\"\n            ></button>\n          `).join('')}\n        </div>\n      </div>\n\n      <div class=\"selector-section\">\n        <p class=\"selector-label\">Length</p>\n        <div class=\"option-group\" id=\"length-group\">\n          ${lengths.map(length => `\n            <button\n              class=\"option-btn ${selectedLength?.id === length.id ? 'selected' : ''}\"\n              data-length-id=\"${length.id}\"\n            >\n              <span class=\"option-btn-primary\">${length.inches}\"</span>\n              <span class=\"option-btn-secondary\">${escapeHtml(length.bodyLandmark)}</span>\n            </button>\n          `).join('')}\n        </div>\n      </div>\n\n      <div class=\"selector-section\">\n        <p class=\"selector-label\">Texture</p>\n        <div class=\"option-group\" id=\"texture-group\">\n          ${textures.map(texture => `\n            <button\n              class=\"option-btn ${selectedTexture?.id === texture.id ? 'selected' : ''}\"\n              data-texture-id=\"${texture.id}\"\n            >\n              <span class=\"option-btn-primary\">${escapeHtml(texture.name)}</span>\n            </button>\n          `).join('')}\n        </div>\n      </div>\n\n      <div class=\"selectors-actions\">\n        <button class=\"btn btn-primary\" id=\"selectors-continue\" ${allSelected ? '' : 'disabled'}>\n          See My Look\n        </button>\n        <button class=\"btn btn-secondary\" id=\"selectors-back\">Change Photo</button>\n      </div>\n    </div>\n  `;\n\n  // Shade click handlers\n  container.querySelectorAll<HTMLElement>('[data-shade-id]').forEach(btn => {\n    btn.addEventListener('click', () => {\n      const shade = shades.find(s => s.id === btn.dataset.shadeId);\n      if (shade) {\n        setState({ selectedShade: shade });\n      }\n    });\n  });\n\n  // Length click handlers\n  container.querySelectorAll<HTMLElement>('[data-length-id]').forEach(btn => {\n    btn.addEventListener('click', () => {\n      const length = lengths.find(l => l.id === btn.dataset.lengthId);\n      if (length) {\n        setState({ selectedLength: length });\n      }\n    });\n  });\n\n  // Texture click handlers\n  container.querySelectorAll<HTMLElement>('[data-texture-id]').forEach(btn => {\n    btn.addEventListener('click', () => {\n      const texture = textures.find(t => t.id === btn.dataset.textureId);\n      if (texture) {\n        setState({ selectedTexture: texture });\n      }\n    });\n  });\n\n  // Continue — submit try-on\n  container.querySelector('#selectors-continue')?.addEventListener('click', () => {\n    handleTryOn();\n  });\n\n  // Back to upload\n  container.querySelector('#selectors-back')?.addEventListener('click', () => {\n    setState({ view: 'upload' });\n  });\n}\n\nasync function handleTryOn(): Promise<void> {\n  const state = getState();\n  if (!state.userPhoto || !state.selectedShade || !state.selectedLength || !state.selectedTexture) return;\n\n  startProcessing();\n\n  try {\n    const result = await submitTryOn(\n      state.userPhoto,\n      state.selectedShade.id,\n      state.selectedLength.id,\n      state.selectedTexture.id,\n      (progress) => {\n        setProgress(progress);\n      }\n    );\n\n    setResult(result);\n  } catch (err: any) {\n    setError(err.message || 'Try-on failed. Please try again.');\n  }\n}\n\nfunction escapeHtml(text: string): string {\n  const div = document.createElement('div');\n  div.textContent = text;\n  return div.innerHTML;\n}\n","export type TryOnEventType =\n  | 'tryon:open'\n  | 'tryon:close'\n  | 'tryon:resultReady'\n  | 'tryon:addToCart';\n\nexport interface TryOnEventDetail {\n  productId?: string;\n  shade?: any;\n  length?: any;\n  texture?: any;\n  tryOnImage?: string;\n}\n\nexport function dispatchTryOnEvent(type: TryOnEventType, detail?: TryOnEventDetail): void {\n  const event = new CustomEvent(type, {\n    bubbles: true,\n    composed: true,\n    detail: detail || {}\n  });\n  document.dispatchEvent(event);\n}\n","import { getState, tryAnotherShade, closeWidget } from '../state';\nimport { dispatchTryOnEvent } from '../events';\n\nlet sliderActive = false;\n\nexport function renderResult(container: HTMLElement): void {\n  const state = getState();\n  if (!state.result) {\n    container.innerHTML = '<p>No result available</p>';\n    return;\n  }\n\n  const resultSrc = `data:${state.result.mimeType};base64,${state.result.imageBase64}`;\n  const originalSrc = state.originalImage || '';\n  const hasOriginal = !!originalSrc;\n  const shadeName = state.selectedShade?.name || '';\n  const lengthLabel = state.selectedLength ? `${state.selectedLength.inches}\"` : '';\n  const textureName = state.selectedTexture?.name || '';\n\n  container.innerHTML = `\n    <div class=\"result-content\">\n      <div class=\"result-selection-bar\">\n        <span class=\"result-selection-chip\" style=\"border-left: 4px solid ${state.selectedShade?.hexColor || '#999'}\">${escapeHtml(shadeName)}</span>\n        <span class=\"result-selection-chip\">${escapeHtml(lengthLabel)}</span>\n        <span class=\"result-selection-chip\">${escapeHtml(textureName)}</span>\n      </div>\n\n      ${hasOriginal ? `\n        <div class=\"result-view-tabs\">\n          <button class=\"result-view-tab active\" id=\"tab-compare\">Before / After</button>\n          <button class=\"result-view-tab\" id=\"tab-result\">Result Only</button>\n        </div>\n      ` : ''}\n\n      <div id=\"result-display\">\n        ${hasOriginal ? renderBeforeAfterHtml(originalSrc, resultSrc) : renderFullImageHtml(resultSrc)}\n      </div>\n\n      <div class=\"result-actions\">\n        <button class=\"btn btn-success\" id=\"result-add-cart\">Add to Cart</button>\n        <button class=\"btn btn-outline\" id=\"result-download\">Download</button>\n        <button class=\"btn btn-outline\" id=\"result-share\">Share</button>\n        <button class=\"btn btn-secondary\" id=\"result-try-another\">Try Another Shade</button>\n      </div>\n\n      <div class=\"result-toast\" id=\"result-toast\"></div>\n    </div>\n  `;\n\n  const display = container.querySelector('#result-display') as HTMLElement;\n\n  // Tab switching (before/after vs result only)\n  if (hasOriginal) {\n    const tabCompare = container.querySelector('#tab-compare') as HTMLElement;\n    const tabResult = container.querySelector('#tab-result') as HTMLElement;\n\n    tabCompare.addEventListener('click', () => {\n      tabCompare.classList.add('active');\n      tabResult.classList.remove('active');\n      display.innerHTML = renderBeforeAfterHtml(originalSrc, resultSrc);\n      attachSliderEvents(display);\n    });\n\n    tabResult.addEventListener('click', () => {\n      tabResult.classList.add('active');\n      tabCompare.classList.remove('active');\n      display.innerHTML = renderFullImageHtml(resultSrc);\n    });\n\n    // Attach slider events for initial before/after view\n    attachSliderEvents(display);\n  }\n\n  // Add to Cart\n  container.querySelector('#result-add-cart')?.addEventListener('click', () => {\n    handleAddToCart(resultSrc);\n  });\n\n  // Download\n  container.querySelector('#result-download')?.addEventListener('click', () => {\n    downloadImage(resultSrc, `muse-hair-pro-${shadeName.toLowerCase().replace(/\\s+/g, '-')}.png`);\n  });\n\n  // Share\n  container.querySelector('#result-share')?.addEventListener('click', () => {\n    handleShare(resultSrc, container);\n  });\n\n  // Try Another Shade\n  container.querySelector('#result-try-another')?.addEventListener('click', () => {\n    tryAnotherShade();\n  });\n\n  // Dispatch result ready event\n  dispatchTryOnEvent('tryon:resultReady', {\n    productId: state.productId,\n    shade: state.selectedShade,\n    tryOnImage: resultSrc,\n  });\n}\n\nfunction renderBeforeAfterHtml(originalSrc: string, resultSrc: string): string {\n  return `\n    <div class=\"before-after-container\" id=\"before-after\">\n      <div class=\"before-after-before\" id=\"before-side\">\n        <img src=\"${originalSrc}\" alt=\"Before\" class=\"before-after-img\" draggable=\"false\" />\n        <span class=\"before-after-label before-label\">Before</span>\n      </div>\n      <div class=\"before-after-after\">\n        <img src=\"${resultSrc}\" alt=\"After\" class=\"before-after-img\" draggable=\"false\" />\n        <span class=\"before-after-label after-label\">After</span>\n      </div>\n      <div class=\"before-after-handle\" id=\"before-after-handle\">\n        <div class=\"before-after-handle-line\"></div>\n        <div class=\"before-after-handle-grip\"></div>\n        <div class=\"before-after-handle-line\"></div>\n      </div>\n    </div>\n  `;\n}\n\nfunction renderFullImageHtml(resultSrc: string): string {\n  return `\n    <div class=\"result-image-container\">\n      <img src=\"${resultSrc}\" alt=\"Hair extension try-on result\" class=\"result-image\" />\n    </div>\n  `;\n}\n\nfunction attachSliderEvents(display: HTMLElement): void {\n  const container = display.querySelector('#before-after') as HTMLElement;\n  const beforeSide = display.querySelector('#before-side') as HTMLElement;\n  const handle = display.querySelector('#before-after-handle') as HTMLElement;\n  if (!container || !beforeSide || !handle) return;\n\n  function updateSlider(clientX: number) {\n    const rect = container.getBoundingClientRect();\n    let pct = ((clientX - rect.left) / rect.width) * 100;\n    pct = Math.max(0, Math.min(100, pct));\n    beforeSide.style.width = `${pct}%`;\n    handle.style.left = `${pct}%`;\n  }\n\n  function onMove(e: MouseEvent | TouchEvent) {\n    if (!sliderActive) return;\n    e.preventDefault();\n    const clientX = 'touches' in e ? e.touches[0].clientX : e.clientX;\n    updateSlider(clientX);\n  }\n\n  function onEnd() {\n    sliderActive = false;\n    document.removeEventListener('mousemove', onMove);\n    document.removeEventListener('mouseup', onEnd);\n    document.removeEventListener('touchmove', onMove);\n    document.removeEventListener('touchend', onEnd);\n  }\n\n  handle.addEventListener('mousedown', (e) => {\n    e.preventDefault();\n    sliderActive = true;\n    document.addEventListener('mousemove', onMove);\n    document.addEventListener('mouseup', onEnd);\n  });\n\n  handle.addEventListener('touchstart', (e) => {\n    e.preventDefault();\n    sliderActive = true;\n    document.addEventListener('touchmove', onMove, { passive: false });\n    document.addEventListener('touchend', onEnd);\n  });\n\n  // Also allow clicking anywhere on the container to move the slider\n  container.addEventListener('click', (e) => {\n    updateSlider(e.clientX);\n  });\n}\n\nasync function handleAddToCart(resultSrc: string): Promise<void> {\n  const state = getState();\n  const variantId = state.selectedShade?.shopifyVariantId;\n\n  // Try Shopify AJAX Cart API if variant ID is available\n  if (variantId && isOnShopify()) {\n    try {\n      const res = await fetch('/cart/add.js', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          items: [{\n            id: Number(variantId),\n            quantity: 1,\n          }],\n        }),\n      });\n\n      if (res.ok) {\n        dispatchTryOnEvent('tryon:addToCart', {\n          productId: state.productId,\n          shade: state.selectedShade,\n          length: state.selectedLength,\n          texture: state.selectedTexture,\n          tryOnImage: resultSrc,\n        });\n        showToast('Added to cart!');\n        return;\n      }\n    } catch (err) {\n      console.warn('[TryOn] Shopify cart add failed, falling back to event:', err);\n    }\n  }\n\n  // Fallback: dispatch event for the host page to handle\n  dispatchTryOnEvent('tryon:addToCart', {\n    productId: state.productId,\n    shade: state.selectedShade,\n    length: state.selectedLength,\n    texture: state.selectedTexture,\n    tryOnImage: resultSrc,\n  });\n  showToast('Added to cart!');\n}\n\nfunction isOnShopify(): boolean {\n  return typeof (window as any).Shopify !== 'undefined';\n}\n\nasync function handleShare(resultSrc: string, container: HTMLElement): Promise<void> {\n  const state = getState();\n  const shareText = [\n    `Check out this look from Muse Hair Pro!`,\n    `Shade: ${state.selectedShade?.name || ''}`,\n    `Length: ${state.selectedLength ? state.selectedLength.inches + '\"' : ''}`,\n    `Texture: ${state.selectedTexture?.name || ''}`,\n  ].join('\\n');\n\n  // Try Web Share API first (mobile-friendly)\n  if (navigator.share) {\n    try {\n      const blob = await dataUrlToBlob(resultSrc);\n      const file = new File([blob], 'muse-hair-pro-tryon.png', { type: blob.type });\n\n      await navigator.share({\n        title: 'My Muse Hair Pro Look',\n        text: shareText,\n        files: [file],\n      });\n      return;\n    } catch (err: any) {\n      // User cancelled or share API doesn't support files — fall through to clipboard\n      if (err.name === 'AbortError') return;\n    }\n  }\n\n  // Fallback: copy text to clipboard\n  try {\n    await navigator.clipboard.writeText(shareText);\n    showToast('Details copied to clipboard!');\n  } catch {\n    // Final fallback: select text\n    showToast('Share: ' + state.selectedShade?.name + ' ' + state.selectedLength?.inches + '\" ' + state.selectedTexture?.name);\n  }\n}\n\nfunction showToast(message: string): void {\n  const toast = document.querySelector('#result-toast') as HTMLElement | null;\n  if (!toast) return;\n  toast.textContent = message;\n  toast.classList.add('visible');\n  setTimeout(() => {\n    toast.classList.remove('visible');\n  }, 2500);\n}\n\nfunction downloadImage(dataUrl: string, filename: string): void {\n  const link = document.createElement('a');\n  link.href = dataUrl;\n  link.download = filename;\n  document.body.appendChild(link);\n  link.click();\n  document.body.removeChild(link);\n}\n\nfunction dataUrlToBlob(dataUrl: string): Promise<Blob> {\n  return fetch(dataUrl).then(r => r.blob());\n}\n\nfunction escapeHtml(text: string): string {\n  const div = document.createElement('div');\n  div.textContent = text;\n  return div.innerHTML;\n}\n","import { getState, closeWidget, subscribe, retryWithSamePhoto, View } from '../state';\nimport { renderConsent } from './ConsentGate';\nimport { renderUpload } from './Upload';\nimport { renderSelectors } from './Selectors';\nimport { renderProgress } from './Progress';\nimport { renderResult } from './Result';\n\nlet previouslyFocused: HTMLElement | null = null;\n\nexport function createModal(shadowRoot: ShadowRoot): HTMLElement {\n  const backdrop = document.createElement('div');\n  backdrop.className = 'backdrop';\n\n  const modal = document.createElement('div');\n  modal.className = 'modal';\n  modal.setAttribute('role', 'dialog');\n  modal.setAttribute('aria-modal', 'true');\n  modal.setAttribute('aria-label', 'Hair Extension Try-On');\n\n  const header = document.createElement('div');\n  header.className = 'header';\n\n  const title = document.createElement('h2');\n  title.className = 'title';\n  title.id = 'tryon-modal-title';\n  title.textContent = 'Hair Extension Try-On';\n  modal.setAttribute('aria-labelledby', 'tryon-modal-title');\n\n  const closeBtn = document.createElement('button');\n  closeBtn.className = 'close-btn';\n  closeBtn.innerHTML = '&times;';\n  closeBtn.setAttribute('aria-label', 'Close');\n  closeBtn.addEventListener('click', closeWidget);\n\n  header.appendChild(title);\n  header.appendChild(closeBtn);\n  modal.appendChild(header);\n\n  const content = document.createElement('div');\n  content.className = 'content';\n  modal.appendChild(content);\n\n  backdrop.appendChild(modal);\n\n  backdrop.addEventListener('click', (e) => {\n    if (e.target === backdrop) {\n      closeWidget();\n    }\n  });\n\n  // Focus trap — Tab and Shift+Tab cycle within the modal\n  modal.addEventListener('keydown', (e) => {\n    if (e.key !== 'Tab') return;\n\n    const focusable = modal.querySelectorAll<HTMLElement>(\n      'button:not([disabled]), input:not([disabled]), [tabindex]:not([tabindex=\"-1\"]), a[href], select, textarea'\n    );\n    if (focusable.length === 0) return;\n\n    const first = focusable[0];\n    const last = focusable[focusable.length - 1];\n\n    if (e.shiftKey) {\n      // Shift+Tab: if on first, wrap to last\n      if (shadowRoot.activeElement === first || document.activeElement === first) {\n        e.preventDefault();\n        last.focus();\n      }\n    } else {\n      // Tab: if on last, wrap to first\n      if (shadowRoot.activeElement === last || document.activeElement === last) {\n        e.preventDefault();\n        first.focus();\n      }\n    }\n  });\n\n  // Subscribe to state changes and render appropriate view\n  subscribe((state) => {\n    renderView(content, state.view, shadowRoot);\n\n    if (state.view === 'closed') {\n      backdrop.classList.remove('visible');\n      // Restore focus to the element that opened the modal\n      if (previouslyFocused) {\n        previouslyFocused.focus();\n        previouslyFocused = null;\n      }\n    } else {\n      backdrop.classList.add('visible');\n      // Save the currently focused element and move focus into the modal\n      if (!previouslyFocused) {\n        previouslyFocused = document.activeElement as HTMLElement;\n      }\n      // Focus the close button after render\n      requestAnimationFrame(() => {\n        closeBtn.focus();\n      });\n    }\n  });\n\n  return backdrop;\n}\n\nfunction renderView(container: HTMLElement, view: View, shadowRoot: ShadowRoot): void {\n  const state = getState();\n\n  switch (view) {\n    case 'closed':\n      container.innerHTML = '';\n      break;\n    case 'consent':\n      renderConsent(container);\n      break;\n    case 'selectors':\n      renderSelectors(container);\n      break;\n    case 'upload':\n      renderUpload(container, shadowRoot);\n      break;\n    case 'processing':\n      renderProgress(container);\n      break;\n    case 'result':\n      renderResult(container);\n      break;\n    case 'error':\n      renderError(container, state.error || 'An unexpected error occurred');\n      break;\n  }\n}\n\nfunction renderError(container: HTMLElement, errorMessage: string): void {\n  container.innerHTML = `\n    <div class=\"error-content\">\n      <div class=\"error-icon\">!</div>\n      <h3 class=\"error-title\">Something went wrong</h3>\n      <p class=\"error-text\">${escapeHtml(errorMessage)}</p>\n      <div class=\"result-actions\">\n        <button class=\"btn btn-primary\" id=\"error-retry\">Try Again</button>\n        <button class=\"btn btn-secondary\" id=\"error-close\">Close</button>\n      </div>\n    </div>\n  `;\n\n  container.querySelector('#error-retry')?.addEventListener('click', retryWithSamePhoto);\n  container.querySelector('#error-close')?.addEventListener('click', closeWidget);\n}\n\nfunction escapeHtml(text: string): string {\n  const div = document.createElement('div');\n  div.textContent = text;\n  return div.innerHTML;\n}\n","import { openWidget, closeWidget, setState, getState } from './state';\nimport { dispatchTryOnEvent } from './events';\nimport { setConfig, WidgetConfig } from './config';\n\nexport interface TryOnAPI {\n  open(options?: { productId?: string }): void;\n  close(): void;\n  _init(config: Partial<WidgetConfig>): void;\n  _ready: boolean;\n}\n\nexport function createAPI(): TryOnAPI {\n  return {\n    _ready: true,\n\n    open(options) {\n      const productId = options?.productId || getState().productId;\n      openWidget(productId);\n      dispatchTryOnEvent('tryon:open', { productId });\n    },\n\n    close() {\n      closeWidget();\n      dispatchTryOnEvent('tryon:close');\n    },\n\n    _init(config) {\n      setConfig(config);\n    }\n  };\n}\n","import { styles } from './styles';\nimport { subscribe, getState, closeWidget } from './state';\nimport { createModal } from './components/Modal';\nimport { createAPI } from './api';\n\nconst HOST_ID = 'tryon-widget-host';\n\nlet host: HTMLElement | null = null;\nlet shadowRoot: ShadowRoot | null = null;\n\nfunction initWidget(): void {\n  // Check if already initialized\n  if (document.getElementById(HOST_ID)) {\n    return;\n  }\n\n  // Create host element with max z-index\n  host = document.createElement('div');\n  host.id = HOST_ID;\n  host.style.cssText = `\n    position: fixed;\n    top: 0;\n    left: 0;\n    width: 0;\n    height: 0;\n    z-index: 2147483647;\n    pointer-events: none;\n  `;\n\n  // Attach Shadow DOM (closed mode for full isolation)\n  shadowRoot = host.attachShadow({ mode: 'closed' });\n\n  // Inject styles\n  const styleEl = document.createElement('style');\n  styleEl.textContent = styles;\n  shadowRoot.appendChild(styleEl);\n\n  // Create modal structure\n  const modal = createModal(shadowRoot);\n  modal.style.pointerEvents = 'auto';\n  shadowRoot.appendChild(modal);\n\n  // Handle visibility\n  subscribe((state) => {\n    if (state.view === 'closed') {\n      host!.style.pointerEvents = 'none';\n    } else {\n      host!.style.pointerEvents = 'auto';\n    }\n  });\n\n  // Handle escape key\n  document.addEventListener('keydown', (e) => {\n    if (e.key === 'Escape' && getState().view !== 'closed') {\n      closeWidget();\n    }\n  });\n\n  document.body.appendChild(host);\n}\n\n// Initialize on load\nfunction init(): void {\n  try {\n    initWidget();\n\n    // Expose public API (overwrites loader)\n    const api = createAPI();\n    (window as any).TryOn = api;\n    (window as any).TryOnWidget = api;\n  } catch (err) {\n    // Error boundary: never let widget errors propagate to the host Shopify store\n    console.error('[TryOn] Widget initialization failed:', err);\n  }\n}\n\n// Global error handler for uncaught errors within the widget\nif (typeof window !== 'undefined') {\n  window.addEventListener('error', (e) => {\n    // Only handle errors from our widget code\n    if (e.filename && e.filename.includes('widget')) {\n      console.error('[TryOn] Uncaught error:', e.message);\n      e.preventDefault(); // Prevent propagation to host page\n    }\n  });\n\n  window.addEventListener('unhandledrejection', (e) => {\n    const reason = e.reason;\n    if (reason && reason.name === 'TryOnError') {\n      console.error('[TryOn] Unhandled rejection:', reason.message);\n      e.preventDefault();\n    }\n  });\n}\n\n// Auto-initialize when DOM is ready\nif (document.readyState === 'loading') {\n  document.addEventListener('DOMContentLoaded', init);\n} else {\n  init();\n}\n\n// Export for module usage\nexport { createAPI };\n"],"names":["styles","initialState","state","listeners","getState","setState","partial","listener","subscribe","openWidget","productId","hasConsent","closeWidget","setConsent","accepted","startProcessing","setProgress","progress","setResult","result","setError","error","retryWithSamePhoto","tryAnotherShade","defaultConfig","config","getConfig","setConfig","newConfig","renderConsent","container","_a","_b","privacyUrl","escapeAttr","text","MAX_DIMENSION","MAX_BYTES","INITIAL_QUALITY","MIN_QUALITY","QUALITY_STEP","compressImage","file","maxBytes","img","loadImage","width","height","ratio","canvas","ctx","quality","blob","canvasToBlob","resolve","reject","url","type","fixOrientation","orientation","getExifOrientation","rotateImage","buffer","view","offset","marker","length","littleEndian","ifdOffset","numEntries","i","ALLOWED_TYPES","MAX_FILE_SIZE","ValidationError","message","validateImage","stream","videoEl","renderCamera","onCapture","video","captureBtn","loading","startCamera","captureSnapshot","err","stopCamera","b","compressed","previewUrl","originalImage","blobToDataUrl","track","reader","activeTab","renderUpload","shadowRoot","renderPreview","renderCaptureTabs","renderDropzone","content","tabUpload","tabCamera","switchTab","tab","renderDropzoneInto","target","zone","input","e","handleFile","oriented","abortController","slowTimer","renderProgress","escapeHtml","clearSlowTimer","subtext","cancelProcessing","getAbortController","div","CLIENT_TIMEOUT","catalogCache","fetchCatalog","baseUrl","shadesRes","lengthsRes","texturesRes","shadesData","lengthsData","texturesData","submitTryOn","userPhoto","shadeId","lengthId","textureId","onProgress","controller","timeoutId","formData","progressTimer","messages","index","response","errorData","parseErrorResponse","TryOnError","data","code","retryable","__publicField","renderSelectors","catalog","renderSelectorsUI","shades","lengths","textures","selectedShade","selectedLength","selectedTexture","allSelected","shade","texture","btn","s","l","t","handleTryOn","dispatchTryOnEvent","detail","event","sliderActive","renderResult","_c","_d","_e","_f","_g","resultSrc","originalSrc","hasOriginal","shadeName","lengthLabel","textureName","renderBeforeAfterHtml","renderFullImageHtml","display","tabCompare","tabResult","attachSliderEvents","handleAddToCart","downloadImage","handleShare","beforeSide","handle","updateSlider","clientX","rect","pct","onMove","onEnd","variantId","isOnShopify","showToast","shareText","dataUrlToBlob","toast","dataUrl","filename","link","r","previouslyFocused","createModal","backdrop","modal","header","title","closeBtn","focusable","first","last","renderView","renderError","errorMessage","createAPI","options","HOST_ID","host","initWidget","styleEl","init","api","reason"],"mappings":"wKAAO,MAAMA,GAAS;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAA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"}