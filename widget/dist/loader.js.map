{"version":3,"file":"loader.js","sources":["../src/loader.ts"],"sourcesContent":["/**\n * TryOn Widget Async Loader\n * Lightweight loader script (<2KB gzipped) that lazy-loads the main widget on first interaction\n */\n\n// Capture script URL at load time (must use document.currentScript for classic/async scripts)\nconst SCRIPT_URL = (document.currentScript as HTMLScriptElement)?.src || '';\nconst WIDGET_SCRIPT_ID = 'tryon-widget-script';\n\ninterface TryOnConfig {\n  apiBaseUrl?: string;\n  privacyPolicyUrl?: string;\n  apiKey?: string | null;\n}\n\ninterface TryOnAPI {\n  open(options?: { productImage?: string; productId?: string }): void;\n  close(): void;\n  setProduct(imageUrl: string, productId?: string): void;\n  _init(config: TryOnConfig): void;\n  _ready: boolean;\n  _pendingOpen?: { productImage: string; productId?: string };\n}\n\n// Store reference to the real widget API once loaded\nlet widgetAPI: TryOnAPI | null = null;\n\nfunction getScriptConfig(): TryOnConfig {\n  // Find the script tag that loaded us to read data attributes\n  const scripts = document.querySelectorAll('script[data-tryon-api], script[data-tryon-api-key], script[src*=\"loader\"]');\n  for (const script of scripts) {\n    const el = script as HTMLScriptElement;\n    if (el.dataset.tryonApi || el.dataset.tryonPrivacy || el.dataset.tryonApiKey) {\n      return {\n        apiBaseUrl: el.dataset.tryonApi || undefined,\n        privacyPolicyUrl: el.dataset.tryonPrivacy || undefined,\n        apiKey: el.dataset.tryonApiKey || null\n      };\n    }\n  }\n  return {};\n}\n\nfunction getWidgetScriptUrl(): string {\n  // Dev mode: loader.ts -> main.ts\n  if (SCRIPT_URL.includes('loader.ts')) {\n    return SCRIPT_URL.replace('loader.ts', 'main.ts');\n  }\n  // Production: loader.js -> widget.js\n  if (SCRIPT_URL.includes('loader.js')) {\n    return SCRIPT_URL.replace('loader.js', 'widget.js');\n  }\n  // Fallback\n  return new URL('./widget.js', SCRIPT_URL).href;\n}\n\nfunction loadWidget(callback: () => void): void {\n  if (document.getElementById(WIDGET_SCRIPT_ID)) {\n    // Already loaded, call callback\n    if (widgetAPI) {\n      callback();\n    }\n    return;\n  }\n\n  const script = document.createElement('script');\n  script.id = WIDGET_SCRIPT_ID;\n  script.src = getWidgetScriptUrl();\n  script.type = 'module';\n  script.onload = () => {\n    // Wait a tick for the module to initialize and set window.TryOn\n    setTimeout(() => {\n      widgetAPI = (window as any).TryOn;\n      callback();\n    }, 0);\n  };\n  script.onerror = () => console.error('[TryOn] Failed to load widget from:', script.src);\n  document.head.appendChild(script);\n}\n\nconst config = getScriptConfig();\n\nconst TryOn: TryOnAPI = {\n  _ready: false,\n\n  open(options) {\n    if (this._ready && widgetAPI) {\n      widgetAPI.open(options);\n    } else {\n      this._pendingOpen = options ? { productImage: options.productImage || '', productId: options.productId } : undefined;\n      loadWidget(() => {\n        if (widgetAPI) {\n          widgetAPI._init(config);\n          this._ready = true;\n          if (this._pendingOpen) {\n            widgetAPI.open(this._pendingOpen);\n            this._pendingOpen = undefined;\n          }\n        }\n      });\n    }\n  },\n\n  close() {\n    if (this._ready && widgetAPI) {\n      widgetAPI.close();\n    }\n  },\n\n  setProduct(imageUrl, productId) {\n    if (this._ready && widgetAPI) {\n      widgetAPI.setProduct(imageUrl, productId);\n    }\n  },\n\n  _init(cfg) {\n    Object.assign(config, cfg);\n  }\n};\n\n(window as any).TryOn = TryOn;\n\nfunction bindButtons(): void {\n  const buttons = document.querySelectorAll<HTMLElement>('[data-tryon-image]');\n  buttons.forEach(button => {\n    if (button.dataset.tryonBound === 'true') return;\n    button.dataset.tryonBound = 'true';\n\n    button.addEventListener('click', () => {\n      const productImage = button.dataset.tryonImage || '';\n      const productId = button.dataset.tryonId;\n      TryOn.open({ productImage, productId });\n    });\n  });\n}\n\nif (document.readyState === 'loading') {\n  document.addEventListener('DOMContentLoaded', bindButtons);\n} else {\n  bindButtons();\n}\n\n// Watch for dynamically added buttons\nconst observer = new MutationObserver(bindButtons);\nobserver.observe(document.body, { childList: true, subtree: true });\n"],"names":["_a","SCRIPT_URL","WIDGET_SCRIPT_ID","widgetAPI","getScriptConfig","scripts","script","el","getWidgetScriptUrl","loadWidget","callback","config","TryOn","options","imageUrl","productId","cfg","bindButtons","button","productImage","observer"],"mappings":"AAMA,IAAAA,EAAA,MAAMC,IAAcD,EAAA,SAAS,gBAAT,YAAAA,EAA8C,MAAO,GACnEE,EAAmB,sBAkBzB,IAAIC,EAA6B,KAEjC,SAASC,GAA+B,CAEtC,MAAMC,EAAU,SAAS,iBAAiB,2EAA2E,EACrH,UAAWC,KAAUD,EAAS,CAC5B,MAAME,EAAKD,EACX,GAAIC,EAAG,QAAQ,UAAYA,EAAG,QAAQ,cAAgBA,EAAG,QAAQ,YAC/D,MAAO,CACL,WAAYA,EAAG,QAAQ,UAAY,OACnC,iBAAkBA,EAAG,QAAQ,cAAgB,OAC7C,OAAQA,EAAG,QAAQ,aAAe,IAAA,CAGxC,CACA,MAAO,CAAA,CACT,CAEA,SAASC,GAA6B,CAEpC,OAAIP,EAAW,SAAS,WAAW,EAC1BA,EAAW,QAAQ,YAAa,SAAS,EAG9CA,EAAW,SAAS,WAAW,EAC1BA,EAAW,QAAQ,YAAa,WAAW,EAG7C,IAAI,IAAI,cAAeA,CAAU,EAAE,IAC5C,CAEA,SAASQ,EAAWC,EAA4B,CAC9C,GAAI,SAAS,eAAeR,CAAgB,EAAG,CAEzCC,GACFO,EAAA,EAEF,MACF,CAEA,MAAMJ,EAAS,SAAS,cAAc,QAAQ,EAC9CA,EAAO,GAAKJ,EACZI,EAAO,IAAME,EAAA,EACbF,EAAO,KAAO,SACdA,EAAO,OAAS,IAAM,CAEpB,WAAW,IAAM,CACfH,EAAa,OAAe,MAC5BO,EAAA,CACF,EAAG,CAAC,CACN,EACAJ,EAAO,QAAU,IAAM,QAAQ,MAAM,sCAAuCA,EAAO,GAAG,EACtF,SAAS,KAAK,YAAYA,CAAM,CAClC,CAEA,MAAMK,EAASP,EAAA,EAETQ,EAAkB,CACtB,OAAQ,GAER,KAAKC,EAAS,CACR,KAAK,QAAUV,EACjBA,EAAU,KAAKU,CAAO,GAEtB,KAAK,aAAeA,EAAU,CAAE,aAAcA,EAAQ,cAAgB,GAAI,UAAWA,EAAQ,SAAA,EAAc,OAC3GJ,EAAW,IAAM,CACXN,IACFA,EAAU,MAAMQ,CAAM,EACtB,KAAK,OAAS,GACV,KAAK,eACPR,EAAU,KAAK,KAAK,YAAY,EAChC,KAAK,aAAe,QAG1B,CAAC,EAEL,EAEA,OAAQ,CACF,KAAK,QAAUA,GACjBA,EAAU,MAAA,CAEd,EAEA,WAAWW,EAAUC,EAAW,CAC1B,KAAK,QAAUZ,GACjBA,EAAU,WAAWW,EAAUC,CAAS,CAE5C,EAEA,MAAMC,EAAK,CACT,OAAO,OAAOL,EAAQK,CAAG,CAC3B,CACF,EAEC,OAAe,MAAQJ,EAExB,SAASK,GAAoB,CACX,SAAS,iBAA8B,oBAAoB,EACnE,QAAQC,GAAU,CACpBA,EAAO,QAAQ,aAAe,SAClCA,EAAO,QAAQ,WAAa,OAE5BA,EAAO,iBAAiB,QAAS,IAAM,CACrC,MAAMC,EAAeD,EAAO,QAAQ,YAAc,GAC5CH,EAAYG,EAAO,QAAQ,QACjCN,EAAM,KAAK,CAAE,aAAAO,EAAc,UAAAJ,CAAA,CAAW,CACxC,CAAC,EACH,CAAC,CACH,CAEI,SAAS,aAAe,UAC1B,SAAS,iBAAiB,mBAAoBE,CAAW,EAEzDA,EAAA,EAIF,MAAMG,EAAW,IAAI,iBAAiBH,CAAW,EACjDG,EAAS,QAAQ,SAAS,KAAM,CAAE,UAAW,GAAM,QAAS,GAAM"}