{"version":3,"file":"loader.js","sources":["../src/loader.ts"],"sourcesContent":["/**\n * TryOn Widget Async Loader\n * Lightweight loader script (<2KB gzipped) that lazy-loads the main widget on first interaction\n */\n\n// Capture script URL at load time\n// - Classic/async scripts: document.currentScript works\n// - Module scripts: document.currentScript is null, use import.meta.url\nconst SCRIPT_URL = (document.currentScript as HTMLScriptElement)?.src || import.meta.url || '';\nconst WIDGET_SCRIPT_ID = 'tryon-widget-script';\nconst IS_DEV = SCRIPT_URL.includes('loader.ts');\n\ninterface TryOnConfig {\n  apiBaseUrl?: string;\n  privacyPolicyUrl?: string;\n}\n\ninterface TryOnAPI {\n  open(options?: { productId?: string }): void;\n  close(): void;\n  _init(config: TryOnConfig): void;\n  _ready: boolean;\n  _pendingOpen?: { productId?: string };\n}\n\n// Store reference to the real widget API once loaded\nlet widgetAPI: TryOnAPI | null = null;\n\nfunction getScriptConfig(): TryOnConfig {\n  // Find the script tag that loaded us to read data attributes\n  const scripts = document.querySelectorAll('script[data-tryon-api], script[src*=\"loader\"]');\n  for (const script of scripts) {\n    const el = script as HTMLScriptElement;\n    if (el.dataset.tryonApi || el.dataset.tryonPrivacy) {\n      return {\n        apiBaseUrl: el.dataset.tryonApi || undefined,\n        privacyPolicyUrl: el.dataset.tryonPrivacy || undefined,\n      };\n    }\n  }\n  return {};\n}\n\nfunction getWidgetScriptUrl(): string {\n  if (IS_DEV) {\n    return SCRIPT_URL.replace('loader.ts', 'main.ts');\n  }\n  if (SCRIPT_URL.includes('loader.js')) {\n    return SCRIPT_URL.replace('loader.js', 'widget.js');\n  }\n  try {\n    return new URL('./widget.js', SCRIPT_URL).href;\n  } catch {\n    return '/widget.js';\n  }\n}\n\nfunction loadWidget(callback: () => void): void {\n  if (document.getElementById(WIDGET_SCRIPT_ID)) {\n    if (widgetAPI) {\n      callback();\n    }\n    return;\n  }\n\n  // In dev mode (Vite), use dynamic import for HMR support\n  if (IS_DEV) {\n    const marker = document.createElement('div');\n    marker.id = WIDGET_SCRIPT_ID;\n    marker.style.display = 'none';\n    document.body.appendChild(marker);\n\n    import(/* @vite-ignore */ getWidgetScriptUrl()).then(() => {\n      widgetAPI = (window as any).TryOn;\n      callback();\n    }).catch((err) => {\n      console.error('[TryOn] Failed to load widget:', err);\n    });\n    return;\n  }\n\n  // Production: inject script tag\n  const script = document.createElement('script');\n  script.id = WIDGET_SCRIPT_ID;\n  script.src = getWidgetScriptUrl();\n  script.type = 'module';\n  script.onload = () => {\n    setTimeout(() => {\n      widgetAPI = (window as any).TryOn;\n      callback();\n    }, 0);\n  };\n  script.onerror = () => console.error('[TryOn] Failed to load widget from:', script.src);\n  document.head.appendChild(script);\n}\n\nconst config = getScriptConfig();\n\nconst TryOnWidget: TryOnAPI = {\n  _ready: false,\n\n  open(options) {\n    if (this._ready && widgetAPI) {\n      widgetAPI.open(options);\n    } else {\n      this._pendingOpen = options;\n      loadWidget(() => {\n        if (widgetAPI) {\n          widgetAPI._init(config);\n          this._ready = true;\n          if (this._pendingOpen) {\n            widgetAPI.open(this._pendingOpen);\n            this._pendingOpen = undefined;\n          } else {\n            widgetAPI.open();\n          }\n        }\n      });\n    }\n  },\n\n  close() {\n    if (this._ready && widgetAPI) {\n      widgetAPI.close();\n    }\n  },\n\n  _init(cfg) {\n    Object.assign(config, cfg);\n  }\n};\n\n// Expose as both TryOnWidget and TryOn for compatibility\n(window as any).TryOnWidget = TryOnWidget;\n(window as any).TryOn = TryOnWidget;\n\n// Auto-bind any buttons with data-tryon-open attribute\nfunction bindButtons(): void {\n  const buttons = document.querySelectorAll<HTMLElement>('[data-tryon-open]');\n  buttons.forEach(button => {\n    if (button.dataset.tryonBound === 'true') return;\n    button.dataset.tryonBound = 'true';\n\n    button.addEventListener('click', () => {\n      const productId = button.dataset.tryonProductId;\n      TryOnWidget.open({ productId });\n    });\n  });\n}\n\nif (document.readyState === 'loading') {\n  document.addEventListener('DOMContentLoaded', bindButtons);\n} else {\n  bindButtons();\n}\n\n// Watch for dynamically added buttons\nconst observer = new MutationObserver(bindButtons);\nobserver.observe(document.body, { childList: true, subtree: true });\n"],"names":["_a","SCRIPT_URL","WIDGET_SCRIPT_ID","IS_DEV","widgetAPI","getScriptConfig","scripts","script","el","getWidgetScriptUrl","loadWidget","callback","marker","err","config","TryOnWidget","options","cfg","bindButtons","button","productId","observer"],"mappings":"AAQA,IAAAA,EAAA,MAAMC,IAAcD,EAAA,SAAS,gBAAT,YAAAA,EAA8C,MAAO,YAAY,KAAO,GACtFE,EAAmB,sBACnBC,EAASF,EAAW,SAAS,WAAW,EAgB9C,IAAIG,EAA6B,KAEjC,SAASC,GAA+B,CAEtC,MAAMC,EAAU,SAAS,iBAAiB,+CAA+C,EACzF,UAAWC,KAAUD,EAAS,CAC5B,MAAME,EAAKD,EACX,GAAIC,EAAG,QAAQ,UAAYA,EAAG,QAAQ,aACpC,MAAO,CACL,WAAYA,EAAG,QAAQ,UAAY,OACnC,iBAAkBA,EAAG,QAAQ,cAAgB,MAAA,CAGnD,CACA,MAAO,CAAA,CACT,CAEA,SAASC,GAA6B,CACpC,GAAIN,EACF,OAAOF,EAAW,QAAQ,YAAa,SAAS,EAElD,GAAIA,EAAW,SAAS,WAAW,EACjC,OAAOA,EAAW,QAAQ,YAAa,WAAW,EAEpD,GAAI,CACF,OAAO,IAAI,IAAI,cAAeA,CAAU,EAAE,IAC5C,MAAQ,CACN,MAAO,YACT,CACF,CAEA,SAASS,EAAWC,EAA4B,CAC9C,GAAI,SAAS,eAAeT,CAAgB,EAAG,CACzCE,GACFO,EAAA,EAEF,MACF,CAGA,GAAIR,EAAQ,CACV,MAAMS,EAAS,SAAS,cAAc,KAAK,EAC3CA,EAAO,GAAKV,EACZU,EAAO,MAAM,QAAU,OACvB,SAAS,KAAK,YAAYA,CAAM,EAEhC,OAA0BH,EAAA,GAAsB,KAAK,IAAM,CACzDL,EAAa,OAAe,MAC5BO,EAAA,CACF,CAAC,EAAE,MAAOE,GAAQ,CAChB,QAAQ,MAAM,iCAAkCA,CAAG,CACrD,CAAC,EACD,MACF,CAGA,MAAMN,EAAS,SAAS,cAAc,QAAQ,EAC9CA,EAAO,GAAKL,EACZK,EAAO,IAAME,EAAA,EACbF,EAAO,KAAO,SACdA,EAAO,OAAS,IAAM,CACpB,WAAW,IAAM,CACfH,EAAa,OAAe,MAC5BO,EAAA,CACF,EAAG,CAAC,CACN,EACAJ,EAAO,QAAU,IAAM,QAAQ,MAAM,sCAAuCA,EAAO,GAAG,EACtF,SAAS,KAAK,YAAYA,CAAM,CAClC,CAEA,MAAMO,EAAST,EAAA,EAETU,EAAwB,CAC5B,OAAQ,GAER,KAAKC,EAAS,CACR,KAAK,QAAUZ,EACjBA,EAAU,KAAKY,CAAO,GAEtB,KAAK,aAAeA,EACpBN,EAAW,IAAM,CACXN,IACFA,EAAU,MAAMU,CAAM,EACtB,KAAK,OAAS,GACV,KAAK,cACPV,EAAU,KAAK,KAAK,YAAY,EAChC,KAAK,aAAe,QAEpBA,EAAU,KAAA,EAGhB,CAAC,EAEL,EAEA,OAAQ,CACF,KAAK,QAAUA,GACjBA,EAAU,MAAA,CAEd,EAEA,MAAMa,EAAK,CACT,OAAO,OAAOH,EAAQG,CAAG,CAC3B,CACF,EAGC,OAAe,YAAcF,EAC7B,OAAe,MAAQA,EAGxB,SAASG,GAAoB,CACX,SAAS,iBAA8B,mBAAmB,EAClE,QAAQC,GAAU,CACpBA,EAAO,QAAQ,aAAe,SAClCA,EAAO,QAAQ,WAAa,OAE5BA,EAAO,iBAAiB,QAAS,IAAM,CACrC,MAAMC,EAAYD,EAAO,QAAQ,eACjCJ,EAAY,KAAK,CAAE,UAAAK,EAAW,CAChC,CAAC,EACH,CAAC,CACH,CAEI,SAAS,aAAe,UAC1B,SAAS,iBAAiB,mBAAoBF,CAAW,EAEzDA,EAAA,EAIF,MAAMG,EAAW,IAAI,iBAAiBH,CAAW,EACjDG,EAAS,QAAQ,SAAS,KAAM,CAAE,UAAW,GAAM,QAAS,GAAM"}